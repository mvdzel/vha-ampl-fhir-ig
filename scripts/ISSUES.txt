
Manually added to generated jsons:
  { "path": "Observation.valueQuantity" },
- output/StructureDefinition-pat-rpt-obs-Observation.json:        "path": "Observation.value[x]",
- output/StructureDefinition-pt-vitals-observation-Observation.json:        "path": "Observation.value[x]",
- output/StructureDefinition-pt-vitals-observation-Observation.json:        "path": "Observation.component.value[x]",

Manually adjusted in VistA_FHIR_Map_5.json:
- // pt-observation-observation -> pt-observation-Observation
- MedicationOrder.medication -> MedicationOrder.medicationCodeableConcept
- MedicationDispense.medication -> MedicationDispense.medicationCodeableConcept
- MedicationDispense.medication.product.+ -> MedicationDispense.medicationReference.product.+
- Observation.value.value -> Observation.value[x].value
- MedicationAdminisration -> MedicationAdministration
- 552: medicationOrder resourcename with capital!
- 548: Location.managingOrganization.name -> .display, reference type has no name!
- // AllergyIntolerance.patient.display <- @reference is the URI to the patient resource instance
- Extension id cannot contain spaces: dispensed drug > dispensedDrug

Manually adjusted in ConceptMap.json:
- conceptMapName: APPOINTMENT STATUS -> AppointmentStatus
- conceptMapName: CLINICAL DANGER LEVEL -> ClinicalDangerLevel
- Concept equavalence lossy > inexact

------------------------
Now running on Java1.8 + Ruby2.3 + Jekyll3.8 (not install jekyll from apt!)
-- gem install jekyll --version 3.8 ; seems to fix gsub issue

Ask Grahame what canonical pattern is???
 extension url doesn't follow canonical pattern: http://va.gov/fhir/StructureDefinition/argo-ethnicity, so omitted from extension summary
 extension url doesn't follow canonical pattern: http://va.gov/fhir/StructureDefinition/createDate, so omitted from extension summary


------------------------
Mapping questions:
- User resource doesnot exist for DSTU2!
- pat-medOrder-ext: indication* <- there is a reason attribute that is for "indication" so this is not an extension but rather a fixed value
- 52.2-.08: requestDate -> MedicationOrder.dateWritten
- VAServiceObservationProfile is prefixed in some paths, invalid and breaks IG Publisher
- Choose: fixed values or constraint (xpath) -> look into slicing

------------------------
Q: 2. We also need a 'package' or a 'group' - one that says, put this VAAllergyIntolerance profile together with these Provenance profiles. We'd publish as one profile if we could but we can't.
A: 2. There is ImplementationGuide.grouping and groupingId that is used for that.

  <grouping id="allergy">
    <name value="Allergy Group"/>	
  </grouping>

  and then for each resource in that group add <groupingId value="allergy"/>

Q: 3. Can we split up the Artifacts, a. specific profiles, b. extensions, c. value sets & maps?
A: 3. Expect this to happen automatically based on constrainedType="StructureDefinition", constrainedType="Extension", constrainedType="ValueSet"

!!!!
Q: How to do Extensions?

  In table now (up to version 4):
   FHIR R2 resource	FHIR R2 property
   "Patient" "extension: raceEthicityCollectionMethod"
   
  A: "Patient" "extension.raceEthicityCollectionMethod" <- if property startswith "extension." then this is an extension!

   @base: "<should match constrainedType>"
   @constrainedType: "Extension"
   @contextType: "resource(.property)"
   @context: [ "<ResourceName(s) where this Extension is applied on>" ]
   Use "special" paths in the mapping table and derive the above attributes.
   !!?? kind: "datatype" or "resource" <-- how do I know from the current table?

  For the "Patient" "extension.raceEthicityCollectionMethod" example:
   @base: "http://hl7.org/fhir/StructureDefinition/Extension"
   @constrainedType: "Extension"
   @contextType: "resource(.property)"
   @context: [ "Patient" ]
   @fullUri: "http://va.gov/fhir/StructureDefinition/reactionDateEntered"

   AND
   > How to include the extension in a profile. Like race in argonaut patient:
   > http://www.fhir.org/guides/argonaut/r2/StructureDefinition-argo-patient.xml.html

        "path" : "Patient.extension",
        "name" : "reactionDateEntered",
        "short" : "Extension",
        "definition" : "An Extension",
        "base" : {
          "path" : "Patient.extension"
        },
        "type" : [
          {
            "code" : "Extension",
            "profile" : [
              "http://va.gov/fhir/StructureDefinition/reactionDateEntered"
            ]
          }
        ]
!!!!

Q: How to get the "extensions" page and format for the Extensions???

Q: 0. figure out how the ig-publisher auto includes some resources and not everything; now have to explicitly put in myig.xml
A: 0. just not put the <resources> tag in there includes all resources in the resources directory. Downside is that you cannot do custom grouping then.

Q: Where to put the mappings of the VAValueSets? ConceptMap and will that render in the IG?

Q: Unable to find profile '' at MedicationDispense.medication or MedicationOrder.medication
  Happens for all profiles that profile these resources and have a medication[x] thing.
  A: Stating the type solves the issue.
      {
	    "path": "MedicationOrder.medicationCodeableConcept"
    },
  - pat-medOrder-ext-MedicationOrder
  - pat-medOrder-MedicationDispense
  - pat-medDispense-MedicationDispense
  - pat-medDispense-ext-MedicationDispense

---------------------------------
Issues in the table
- Data_x0020_Elements used as .short should not start or end with space
- [x] must be in path when applicable, e.g. for Observation.value, effective, medication, etc.
- whitespaces cannot be in paths
- resourcename must start with a capital
- typo, missing 't' in "MedicationAdminisration"
- a lot of "Error in snapshot generation: Differential for <profileId> has an element id: <path> that is not marked with a snapshot match - check validity of differential (including order)"
  Those are not existing paths!
  Not blocking for IG publication.
- pt-observation-observation & pt-observation-Observation <- is in there twice cap and small typo!

- when property is a [x] property you need a path with the type added, e.g. for pt-vitals-Observation!
    {
	    "path": "Observation.valueQuantity"
    },
  This is BLOCKING for IG publication (during snapshot generation).
  Herkenbaar aan: java.lang.IndexOutOfBoundsException: Index: 0, Size: 0
	at java.util.ArrayList.rangeCheck(ArrayList.java:657)
	at java.util.ArrayList.get(ArrayList.java:433)
	at org.hl7.fhir.r5.conformance.ProfileUtilities.processPaths(ProfileUtilities.java:675)
	at org.hl7.fhir.r5.conformance.ProfileUtilities.generateSnapshot(ProfileUtilities.java:472)
	at org.hl7.fhir.igtools.publisher.Publisher.generateSnapshot(Publisher.java:3779)
- AllergyIntolerance.patient.reference.display and then a mapping is not valid
-- should be a profile on Patient with a mapping added to patient.display: YES
-- [] paths cannot go beyond reference?! Check with Grahame..

-----------------
Validate the profiles first through:
POST to https://r2.smarthealthit.org//StructureDefinition/$validate
Helps a little bit, doesnot check for valid paths.

or the "official" validator
> java -jar org.hl7.fhir.validator-4.1.19.jar -version 1.0.2 -snapshot input/resources/StructureDefinition-pt-Patient.json 

!! TODO: Turns out that the "Error in snapshot generation" is caused by the order of the elements. 
!! Turns out the order of the element paths must be in the order it has in the base resource property and datatype attributes.
------------------
Get IG Publisher (& Validator) from:
https://github.com/FHIR/latest-ig-publisher